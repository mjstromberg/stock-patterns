<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Stock Pattern Analyzer</title>
    <link rel="stylesheet" href="assets/stylesheets/main.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.rawgit.com/etpinard/plotlyjs-finance/master/plotlyjs-finance.js"></script>
    <!--<script src="/assets/javascripts/tester.js"></script>-->
  </head>
  <body>
    <h1>Stock Pattern Analyzer</h1>
    <p>Pick a stock:</p>
    <div id="ohlcChart" style="width:800px;height:400px;"></div>
    <label>
      <input type="text" id="ajaxTextbox"/>
    </label>
    <span id="ajaxButton" style="cursor: pointer; text-decoration: underline">Enter Ticker Symbol</span>
    
    <script type="text/javascript">
      (function() {
        var httpRequest;
        
        document.getElementById("ajaxButton").onclick = function() {
          var stockName = document.getElementById("ajaxTextbox").value.toString().toUpperCase();
          var stockURL = 'https://www.quandl.com/api/v3/datasets/WIKI/' + stockName + '.json?api_key=fyWKH12nMF4VuWFaXARN&limit=100';
          
          if (stockName) {
            makeRequest(stockURL);
          }
        }
        
        function makeRequest(url) {
          httpRequest = new XMLHttpRequest();
          
          if (!httpRequest) {
            alert('Unable to create an XMLHTTP instance.');
            return false;
          }
          
          httpRequest.onreadystatechange = alertContents;
          httpRequest.open('GET', url);
          httpRequest.send();
        }
        
        function alertContents() {
          try {
            if (httpRequest.readyState === XMLHttpRequest.DONE) {
              if (httpRequest.status === 200) {
                var response = JSON.parse(httpRequest.responseText).dataset.data;
                
                // Reformat Data
                var reformatData = response.reduce(function(result, dayArrayData) {
                  result[4].push([ dayArrayData[0].slice(0, 4), dayArrayData[0].slice(5, 7), dayArrayData[0].slice(8) ]);
                  result[0].push(dayArrayData[1]);
                  result[1].push(dayArrayData[2]);
                  result[2].push(dayArrayData[3]);
                  result[3].push(dayArrayData[4]);
                }, [ [], [], [], [], [] ]);
                
                // Create Plotly OHLC Chart
                var fig = PlotlyFinance.createOHLC(
                  {
                    open: reformatData[0],
                    high: reformatData[1],
                    low: reformatData[2],
                    close: reformatData[3],
                    dates: reformatData[4].map(function(d) { return new Date(d[0], d[1]-1, d[2]); })
                  }
                );
                Plotly.newPlot('ohlcChart', fig.data, fig.layout);
                
              } else {
                alert('There was a problem with the request.');
              }
            }
          }
          catch( e ) {
            alert('Caught Exception: ' + e.description);
          }
        }
      })();
    </script>
  </body>
</html>

















